<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0067)http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <title>MPI — AMath 483/583, Spring 2013 1.0 documentation</title>
    
    <link rel="stylesheet" href="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/default.css" type="text/css">
    <link rel="stylesheet" href="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/jquery.js"></script>
    <script type="text/javascript" src="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/underscore.js"></script>
    <script type="text/javascript" src="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/doctools.js"></script>
    <script type="text/javascript" src="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/MathJax.js"></script>
    <link rel="author" title="About these documents" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/about.html">
    <link rel="top" title="AMath 483/583, Spring 2013 1.0 documentation" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/index.html">
    <link rel="next" title="Makefiles" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/makefiles.html">
    <link rel="prev" title="OpenMP" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/openmp.html"> 
  <style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style></head>
  <body><div id="MathJax_Message" style="display: none;"></div>

<div style="background-color: #F0D576; text-align: left; padding: 10px 10px 15px 15px">
<table>
<tbody><tr>
<td>
<a href="http://www.amath.washington.edu/"><img src="./MPI — AMath 483 583, Spring 2013 1.0 documentation_files/uwamath.gif" border="0" alt="UW AMath"></a>
</td>
<td>
<font size="5"> High Performance Scientific Computing</font>
<br>&nbsp;<br>
<font size="5"> AMath 483/583 Class Notes</font>
<br>&nbsp;<br>
<font size="5"> Spring Quarter, 2013 </font>
</td>
</tr>
</tbody></table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/genindex.html" title="General Index" accesskey="I">index</a></li>
        <li class="right">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/makefiles.html" title="Makefiles" accesskey="N">next</a> |</li>
        <li class="right">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/openmp.html" title="OpenMP" accesskey="P">previous</a> |</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/index.html"><font color="#39275b">Contents</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/biblio.html"><font color="#39275b">Bibliography</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/search.html"><font color="#39275b">Search</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/index.html"><font color="#39275b">Class Webpage</font></a>|&nbsp;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#">MPI</a><ul>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#mpi-implementations">MPI implementations</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#mpi-on-the-class-vm">MPI on the class VM</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#test-code">Test code</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#reduction-example">Reduction example</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#send-receive-example">Send-Receive example</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#master-worker-examples">Master-worker examples</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#sample-codes">Sample codes</a></li>
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#further-reading">Further reading</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/openmp.html" title="previous chapter">OpenMP</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/makefiles.html" title="next chapter">Makefiles</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/_sources/mpi.txt" rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="">
  <h3>Quick search</h3>
    <form class="search" action="http://faculty.washington.edu/rjl/classes/am583s2013/notes/search.html" method="get">
      <input type="text" name="q">
      <input type="submit" value="Go">
      <input type="hidden" name="check_keywords" value="yes">
      <input type="hidden" name="area" value="default">
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mpi">
<span id="id1"></span><h1>MPI<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#mpi" title="Permalink to this headline">¶</a></h1>
<p>MPI stands for <em>Message Passing Interface</em> and is a standard approach for
programming distributed memory machines such as clusters, supercomputers, or
heterogeneous networks of computers.  It can also be used on a single
shared memory computer, although it is often more cumbersome to program in
MPI than in OpenMP.</p>
<div class="section" id="mpi-implementations">
<h2>MPI implementations<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#mpi-implementations" title="Permalink to this headline">¶</a></h2>
<p>A number of different implementations are available (open source and vendor
supplied for specific machines).   See
<a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/implementations.html">this list</a>, for
example.</p>
</div>
<div class="section" id="mpi-on-the-class-vm">
<h2>MPI on the class VM<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#mpi-on-the-class-vm" title="Permalink to this headline">¶</a></h2>
<p>The VM has <a class="reference external" href="http://www.open-mpi.org/">open-mpi</a>  partially installed.</p>
<p>You will need to do the following:</p>
<div class="highlight-python"><pre>$ sudo apt-get update
$ sudo apt-get install openmpi-dev</pre>
</div>
<p>On other Ubuntu installations you will also have to do:</p>
<div class="highlight-python"><pre>$ sudo apt-get install openmpi-bin          # Already on the VM</pre>
</div>
<p>You should then be able to do the following:</p>
<div class="highlight-python"><pre>$ cd $UWHPSC/codes/mpi
$ mpif90 test1.f90
$ mpiexec -n 4 a.out</pre>
</div>
<p>and see output like:</p>
<div class="highlight-python"><pre>Hello from Process number           1  of            4  processes
Hello from Process number           3  of            4  processes
Hello from Process number           0  of            4  processes
Hello from Process number           2  of            4  processes</pre>
</div>
</div>
<div class="section" id="test-code">
<h2>Test code<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#test-code" title="Permalink to this headline">¶</a></h2>
<p>The simple test code used above illustrates use of some of the basic MPI
subroutines.</p>
<div class="highlight-fortran"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">! $UWHPSC/codes/mpi/test1.f90</span>

<span class="k">program </span><span class="nv">test1</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ierr</span><span class="p">,</span> <span class="nv">numprocs</span><span class="p">,</span> <span class="nv">proc_num</span>

    <span class="k">call </span><span class="nv">mpi_init</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">mpi_comm_size</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">numprocs</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">mpi_comm_rank</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">'Hello from Process number'</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="p">&amp;</span>
             <span class="s1">' of '</span><span class="p">,</span> <span class="nv">numprocs</span><span class="p">,</span> <span class="s1">' processes'</span>

    <span class="k">call </span><span class="nv">mpi_finalize</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="nv">test1</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="reduction-example">
<h2>Reduction example<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#reduction-example" title="Permalink to this headline">¶</a></h2>
<p>The next example uses <cite>MPI_REDUCE</cite> to add up partial sums computed by
independent processes.</p>
<div class="highlight-fortran"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">! $UWHPSC/codes/mpi/pisum1.f90</span>

<span class="c">! Computes pi using MPI.  </span>
<span class="c">! Compare to $UWHPSC/codes/openmp/pisum2.f90 </span>

<span class="k">program </span><span class="nv">pisum1</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ierr</span><span class="p">,</span> <span class="nv">numprocs</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">points_per_proc</span><span class="p">,</span> <span class="nv">n</span><span class="p">,</span> <span class="p">&amp;</span>
               <span class="nv">i</span><span class="p">,</span> <span class="nv">istart</span><span class="p">,</span> <span class="nv">iend</span>
    <span class="kt">real</span> <span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">x</span><span class="p">,</span> <span class="nv">dx</span><span class="p">,</span> <span class="nv">pisum</span><span class="p">,</span> <span class="nv">pisum_proc</span><span class="p">,</span> <span class="nv">pi</span>

    <span class="k">call </span><span class="nv">mpi_init</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">mpi_comm_size</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">numprocs</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">mpi_comm_rank</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="c">! Ask the user for the number of points</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Using "</span><span class="p">,</span><span class="nv">numprocs</span><span class="p">,</span><span class="s2">" processors"</span>
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Input n ... "</span>
        <span class="k">read</span> <span class="o">*</span><span class="p">,</span> <span class="nv">n</span>
    <span class="k">end if</span>

    <span class="c">! Broadcast to all procs; everybody gets the value of n from proc 0</span>
    <span class="k">call </span><span class="nv">mpi_bcast</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="nv">dx</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d0</span><span class="o">/</span><span class="nv">n</span>

    <span class="c">! Determine how many points to handle with each proc</span>
    <span class="nv">points_per_proc</span> <span class="o">=</span> <span class="p">(</span><span class="nv">n</span> <span class="o">+</span> <span class="nv">numprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nv">numprocs</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! Only one proc should print to avoid clutter</span>
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"points_per_proc = "</span><span class="p">,</span> <span class="nv">points_per_proc</span>
    <span class="k">end if</span>

    <span class="c">! Determine start and end index for this proc's points</span>
    <span class="nv">istart</span> <span class="o">=</span> <span class="nv">proc_num</span> <span class="o">*</span> <span class="nv">points_per_proc</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="nv">proc_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nv">points_per_proc</span><span class="p">,</span> <span class="nv">n</span><span class="p">)</span>

    <span class="c">! Diagnostic: tell the user which points will be handled by which proc</span>
    <span class="k">print</span> <span class="s1">'("Process ",i2," will take i = ",i6," through i = ",i6)'</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">istart</span><span class="p">,</span> <span class="nv">iend</span>

    <span class="nv">pisum_proc</span> <span class="o">=</span> <span class="mf">0.</span><span class="nv">d0</span>
    <span class="k">do </span><span class="nv">i</span><span class="o">=</span><span class="nv">istart</span><span class="p">,</span><span class="nv">iend</span>
        <span class="nv">x</span> <span class="o">=</span> <span class="p">(</span><span class="nv">i</span><span class="o">-</span><span class="mf">0.5</span><span class="nv">d0</span><span class="p">)</span><span class="o">*</span><span class="nv">dx</span>
        <span class="nv">pisum_proc</span> <span class="o">=</span> <span class="nv">pisum_proc</span> <span class="o">+</span> <span class="mf">1.</span><span class="nv">d0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="nv">d0</span> <span class="o">+</span> <span class="nv">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nv">enddo</span>

    <span class="k">call </span><span class="nv">MPI_REDUCE</span><span class="p">(</span><span class="nv">pisum_proc</span><span class="p">,</span><span class="nv">pisum</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span><span class="nv">MPI_SUM</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">pi</span> <span class="o">=</span> <span class="mf">4.</span><span class="nv">d0</span> <span class="o">*</span> <span class="nv">dx</span> <span class="o">*</span> <span class="nv">pisum</span> 
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"The approximation to pi is "</span><span class="p">,</span><span class="nv">pi</span>
        <span class="k">endif</span>

<span class="k">    call </span><span class="nv">mpi_finalize</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="nv">pisum1</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="send-receive-example">
<h2>Send-Receive example<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#send-receive-example" title="Permalink to this headline">¶</a></h2>
<p>In this example, a value is set in Process 0 and then passed to Process 1
and on to Process 2, etc. until it reaches the last process, where it is
printed out.</p>
<div class="highlight-fortran"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">! $UWHPSC/codes/mpi/copyvalue.f90</span>
<span class="c">!</span>
<span class="c">! Set value in Process 0 and copy this through a chain of processes</span>
<span class="c">! and finally print result from Process numprocs-1.</span>
<span class="c">!</span>

<span class="k">program </span><span class="nv">copyvalue</span>

    <span class="k">use </span><span class="nv">mpi</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span><span class="nv">ierr</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="nv">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">status</span>

    <span class="k">call </span><span class="nv">MPI_INIT</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_SIZE</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_RANK</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">num_procs</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Only one process, cannot do anything"</span>
        <span class="k">call </span><span class="nv">MPI_FINALIZE</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="k">stop</span>
<span class="k">        endif</span>


<span class="k">    if</span> <span class="p">(</span><span class="nv">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">55</span>
        <span class="k">print</span> <span class="s1">'("Process ",i3," setting      i = ",i3)'</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">i</span>

        <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">&lt;</span> <span class="nv">num_procs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">proc_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">'("Process ",i3," receives     i = ",i3)'</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">i</span>
        <span class="k">print</span> <span class="s1">'("Process ",i3," sends        i = ",i3)'</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">i</span>

        <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">proc_num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>


      <span class="k">else if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="nv">num_procs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">proc_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">'("Process ",i3," ends up with i = ",i3)'</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">i</span>
      <span class="k">endif</span>

<span class="k">    call </span><span class="nv">MPI_FINALIZE</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="nv">copyvalue</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="master-worker-examples">
<h2>Master-worker examples<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#master-worker-examples" title="Permalink to this headline">¶</a></h2>
<p>The next two examples illustrate using Process 0 as a <em>master</em> process to
farm work out to the other processes.  In both cases the 1-norm of a matrix
is computed, which is the maximum over <cite>j</cite> of the 1-norm of the <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#id2"><span class="problematic" id="id3">`</span></a>j`th column
of the matrix.</p>
<p>In the first case we assume there are the same number of worker processes as
columns in the matrix:</p>
<div class="highlight-fortran"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">! $UWHPSC/codes/mpi/matrix1norm1.f90</span>
<span class="c">!</span>
<span class="c">! Compute 1-norm of a matrix using mpi.</span>
<span class="c">! Process 0 is the master that sets things up and then sends a column</span>
<span class="c">! to each worker (Processes 1, 2, ..., num_procs - 1).</span>
<span class="c">!</span>
<span class="c">! This version assumes there are at least as many workers as columns.</span>

<span class="k">program </span><span class="nv">matrix1norm1</span>

    <span class="k">use </span><span class="nv">mpi</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">jj</span><span class="p">,</span><span class="nv">nrows</span><span class="p">,</span><span class="nv">ncols</span><span class="p">,</span><span class="nv">proc_num</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span><span class="nv">ierr</span><span class="p">,</span><span class="nv">nerr</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="nv">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">status</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">colnorm</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="nv">a</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="nv">anorm</span><span class="p">,</span> <span class="nv">colvect</span>

    <span class="k">call </span><span class="nv">MPI_INIT</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_SIZE</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_RANK</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="nv">nerr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Input nrows, ncols"</span>
        <span class="k">read</span> <span class="o">*</span><span class="p">,</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">ncols</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">ncols</span> <span class="o">&gt;</span> <span class="nv">num_procs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"*** Error, this version requires ncols &lt; num_procs = "</span><span class="p">,&amp;</span>
                  <span class="nv">num_procs</span>
            <span class="nv">nerr</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">endif</span>
<span class="k">        allocate</span><span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="nv">nrows</span><span class="p">,</span><span class="nv">ncols</span><span class="p">))</span>  <span class="c">! only master process 0 needs the matrix</span>
        <span class="nv">a</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d0</span>  <span class="c">! initialize to all 1's for this test</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">anorm</span><span class="p">(</span><span class="nv">ncols</span><span class="p">))</span>    <span class="c">! to hold norm of each column in MPI_RECV</span>
        <span class="k">endif</span>

    <span class="c">! if nerr == 1 then all processes must stop:</span>
    <span class="k">call </span><span class="nv">MPI_BCAST</span><span class="p">(</span><span class="nv">nerr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">nerr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Note that error message already printed by Process 0</span>
        <span class="c">! All processes must execute the MPI_FINALIZE </span>
        <span class="c">! (Could also just have "go to 99" here.)</span>
        <span class="k">call </span><span class="nv">MPI_FINALIZE</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="k">stop</span>
<span class="k">        endif</span>
<span class="k">        </span>
<span class="k">    call </span><span class="nv">MPI_BCAST</span><span class="p">(</span><span class="nv">nrows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_BCAST</span><span class="p">(</span><span class="nv">ncols</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        allocate</span><span class="p">(</span><span class="nv">colvect</span><span class="p">(</span><span class="nv">nrows</span><span class="p">))</span>   <span class="c">! to hold a column vector sent from master</span>
        <span class="k">endif</span> 


    
    <span class="c">! -----------------------------------------</span>
    <span class="c">! code for Master (Processor 0):</span>
    <span class="c">! -----------------------------------------</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">      do </span><span class="nv">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">ncols</span>
        <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">j</span><span class="p">),</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                        <span class="nv">j</span><span class="p">,</span> <span class="nv">j</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">enddo</span>

      <span class="k">do </span><span class="nv">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">ncols</span>
        <span class="k">call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">colnorm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="nv">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">jj</span> <span class="o">=</span> <span class="nv">status</span><span class="p">(</span><span class="nv">MPI_TAG</span><span class="p">)</span>
        <span class="nv">anorm</span><span class="p">(</span><span class="nv">jj</span><span class="p">)</span> <span class="o">=</span> <span class="nv">colnorm</span>
        <span class="nv">enddo</span>

      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Finished filling anorm with values... "</span>
      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="nv">anorm</span>
      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"1-norm of matrix a = "</span><span class="p">,</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">anorm</span><span class="p">)</span>
      <span class="k">endif</span>


    <span class="c">! -----------------------------------------</span>
    <span class="c">! code for Workers (Processors 1, 2, ...):</span>
    <span class="c">! -----------------------------------------</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">&gt;</span> <span class="nv">ncols</span><span class="p">)</span> <span class="nv">go</span> <span class="nv">to</span> <span class="mi">99</span>   <span class="c">! no work expected</span>

        <span class="k">call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">colvect</span><span class="p">,</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

        <span class="nv">j</span> <span class="o">=</span> <span class="nv">status</span><span class="p">(</span><span class="nv">MPI_TAG</span><span class="p">)</span>   <span class="c">! this is the column number</span>
                              <span class="c">! (should agree with proc_num)</span>

        <span class="nv">colnorm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nv">colvect</span><span class="p">))</span>

        <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">colnorm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="nv">j</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

        <span class="k">endif</span>

<span class="mi">99</span>  <span class="k">continue</span>   <span class="c">! might jump to here if finished early</span>
    <span class="k">call </span><span class="nv">MPI_FINALIZE</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="nv">matrix1norm1</span>


            
</pre></div>
</td></tr></tbody></table></div>
<p>In the next case we consider the more realistic situation where there may be
many more columns in the matrix than worker processes.  In this case the
<em>master</em> process must do more work to keep track of how which columns have
already been handled and farm out work as worker processes become free.</p>
<div class="highlight-fortran"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">! $UWHPSC/codes/mpi/matrix1norm1.f90</span>
<span class="c">!</span>
<span class="c">! Compute 1-norm of a matrix using mpi.</span>
<span class="c">! Process 0 is the master that sets things up and then sends a column</span>
<span class="c">! to each worker (Processes 1, 2, ..., num_procs - 1).</span>
<span class="c">!</span>
<span class="c">! This version allows more columns than workers.</span>

<span class="k">program </span><span class="nv">matrix1norm2</span>

    <span class="k">use </span><span class="nv">mpi</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">jj</span><span class="p">,</span><span class="nv">nrows</span><span class="p">,</span><span class="nv">ncols</span><span class="p">,</span><span class="nv">proc_num</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span><span class="nv">ierr</span><span class="p">,</span><span class="nv">nerr</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">numsent</span><span class="p">,</span> <span class="nv">sender</span><span class="p">,</span> <span class="nv">nextcol</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="nv">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">status</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">colnorm</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="nv">a</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="nv">anorm</span><span class="p">,</span> <span class="nv">colvect</span>

    <span class="kt">logical</span> <span class="kd">::</span> <span class="nv">debug</span>

    <span class="nv">debug</span> <span class="o">=</span> <span class="nb">.true.</span>

    <span class="k">call </span><span class="nv">MPI_INIT</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_SIZE</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">num_procs</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_COMM_RANK</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Input nrows, ncols"</span>
        <span class="k">read</span> <span class="o">*</span><span class="p">,</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">ncols</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="nv">nrows</span><span class="p">,</span><span class="nv">ncols</span><span class="p">))</span>  <span class="c">! only master process 0 needs the matrix</span>
        <span class="nv">a</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d0</span>  <span class="c">! initialize to all 1's for this test</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">anorm</span><span class="p">(</span><span class="nv">ncols</span><span class="p">))</span>    <span class="c">! to hold norm of each column in MPI_RECV</span>
        <span class="k">endif</span>

<span class="k">        </span>
<span class="k">    call </span><span class="nv">MPI_BCAST</span><span class="p">(</span><span class="nv">nrows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_BCAST</span><span class="p">(</span><span class="nv">ncols</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        allocate</span><span class="p">(</span><span class="nv">colvect</span><span class="p">(</span><span class="nv">nrows</span><span class="p">))</span>   <span class="c">! to hold a column vector sent from master</span>
        <span class="k">endif</span> 


    
    <span class="c">! -----------------------------------------</span>
    <span class="c">! code for Master (Processor 0):</span>
    <span class="c">! -----------------------------------------</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">      </span><span class="nv">numsent</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">! keep track of how many columns sent</span>

      <span class="c">! send the first batch to get all workers working:</span>
      <span class="k">do </span><span class="nv">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="nv">num_procs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">ncols</span><span class="p">)</span>
        <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">j</span><span class="p">),</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                        <span class="nv">j</span><span class="p">,</span> <span class="nv">j</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">numsent</span> <span class="o">=</span> <span class="nv">numsent</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nv">enddo</span>

      <span class="c">! as results come back, send out more work...</span>
      <span class="c">! the variable sender tells who sent back a result and ready for more</span>
      <span class="k">do </span><span class="nv">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">ncols</span>
        <span class="k">call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">colnorm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="nv">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">sender</span> <span class="o">=</span> <span class="nv">status</span><span class="p">(</span><span class="nv">MPI_SOURCE</span><span class="p">)</span>
        <span class="nv">jj</span> <span class="o">=</span> <span class="nv">status</span><span class="p">(</span><span class="nv">MPI_TAG</span><span class="p">)</span>
        <span class="nv">anorm</span><span class="p">(</span><span class="nv">jj</span><span class="p">)</span> <span class="o">=</span> <span class="nv">colnorm</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">numsent</span> <span class="o">&lt;</span> <span class="nv">ncols</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! still more work to do, the next column will be sent and</span>
            <span class="c">! this index also used as the tag:</span>
            <span class="nv">nextcol</span> <span class="o">=</span> <span class="nv">numsent</span> <span class="o">+</span> <span class="mi">1</span> 
            <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">nextcol</span><span class="p">),</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                            <span class="nv">sender</span><span class="p">,</span> <span class="nv">nextcol</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
            <span class="nv">numsent</span> <span class="o">=</span> <span class="nv">numsent</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">else</span>
            <span class="c">! send an empty message with tag=0 to indicate this worker</span>
            <span class="c">! is done:</span>
            <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">MPI_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                            <span class="nv">sender</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
          <span class="k">endif</span>
<span class="k">            </span>
<span class="k">        </span><span class="nv">enddo</span>

      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"Finished filling anorm with values... "</span>
      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="nv">anorm</span>
      <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">"1-norm of matrix a = "</span><span class="p">,</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">anorm</span><span class="p">)</span>
      <span class="k">endif</span>


    <span class="c">! -----------------------------------------</span>
    <span class="c">! code for Workers (Processors 1, 2, ...):</span>
    <span class="c">! -----------------------------------------</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="nv">proc_num</span> <span class="o">&gt;</span> <span class="nv">ncols</span><span class="p">)</span> <span class="nv">go</span> <span class="nv">to</span> <span class="mi">99</span>   <span class="c">! no work expected</span>

        <span class="k">do while</span> <span class="p">(</span><span class="nb">.true.</span><span class="p">)</span>
            <span class="c">! repeat until message with tag==0 received...</span>

            <span class="k">call </span><span class="nv">MPI_RECV</span><span class="p">(</span><span class="nv">colvect</span><span class="p">,</span> <span class="nv">nrows</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,&amp;</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="nv">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                          <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

            <span class="nv">j</span> <span class="o">=</span> <span class="nv">status</span><span class="p">(</span><span class="nv">MPI_TAG</span><span class="p">)</span>   <span class="c">! this is the column number</span>
                                  <span class="c">! may not be proc_num in general</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">debug</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                print</span> <span class="s1">'("+++ Process ",i4,"  received message with tag ",i6)'</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="nv">proc_num</span><span class="p">,</span> <span class="nv">j</span>       
                <span class="k">endif</span>

<span class="k">            if</span> <span class="p">(</span><span class="nv">j</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="nv">go</span> <span class="nv">to</span> <span class="mi">99</span>    <span class="c">! received "done" message</span>

            <span class="nv">colnorm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nv">colvect</span><span class="p">))</span>

            <span class="k">call </span><span class="nv">MPI_SEND</span><span class="p">(</span><span class="nv">colnorm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="nv">j</span><span class="p">,</span> <span class="nv">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

            <span class="nv">enddo</span>
        <span class="k">endif</span>

<span class="mi">99</span>  <span class="k">continue</span>   <span class="c">! might jump to here if finished early</span>
    <span class="k">call </span><span class="nv">MPI_FINALIZE</span><span class="p">(</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="nv">matrix1norm2</span>


            
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="sample-codes">
<h2>Sample codes<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#sample-codes" title="Permalink to this headline">¶</a></h2>
<p>Some other sample codes can also be found in the <cite>$UWHPSC/codes/mpi</cite> directory.</p>
<ul class="simple">
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/jacobi1d_mpi.html#jacobi1d-mpi"><em>Jacobi iteration using MPI</em></a></li>
</ul>
<p>See also the samples in the list below.</p>
</div>
<div class="section" id="further-reading">
<h2>Further reading<a class="headerlink" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/mpi.html#further-reading" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/biblio.html#biblio-mpi"><em>MPI references</em></a> section of the bibliography lists some books.</li>
<li><a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/tutorial/">Argonne tutorials</a></li>
<li><a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/tutorial/gropp/talk.html">Tutorial slides by Bill Gropp</a></li>
<li><a class="reference external" href="https://computing.llnl.gov/tutorials/mpi/">Livermore tutorials</a></li>
<li><a class="reference external" href="http://www.open-mpi.org/">Open MPI</a></li>
<li><a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/">The MPI Standard</a></li>
<li><a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/usingmpi/examples/simplempi/main.htm">Some sample codes</a></li>
<li><a class="reference external" href="http://www.lam-mpi.org/tutorials/">LAM MPI tutorials</a></li>
<li>Google “MPI tutorial” to find more.</li>
<li><a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/www/www3/">Documentation on MPI subroutines</a></li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/genindex.html" title="General Index">index</a></li>
        <li class="right">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/makefiles.html" title="Makefiles">next</a> |</li>
        <li class="right">
          <a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/openmp.html" title="OpenMP">previous</a> |</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/index.html"><font color="#39275b">Contents</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/biblio.html"><font color="#39275b">Bibliography</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/notes/search.html"><font color="#39275b">Search</font></a>|&nbsp;</li>
        <li><a href="http://faculty.washington.edu/rjl/classes/am583s2013/index.html"><font color="#39275b">Class Webpage</font></a>|&nbsp;</li>
 
      </ul>
    </div>
    <div class="footer">
        © Copyright 2013, Randall J. LeVeque, CC BY.
      Last updated on May 29, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  
</body></html>